name: Deploy Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - 'midfield/supabase/functions/**'
      - 'midfield/supabase/config.toml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      PROJECT_ID: oerbyhaqhuixpjrubshm
    
    defaults:
      run:
        working-directory: midfield

    steps:
      - uses: actions/checkout@v4
      
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Livescores Function
        run: supabase functions deploy cron-livescores --project-ref $PROJECT_ID --no-verify-jwt

      - name: Deploy Purge Notifications Function
        run: supabase functions deploy cron-purge-notifications --project-ref $PROJECT_ID --no-verify-jwt
        
      - name: Set Secrets
        run: |
          supabase secrets set --project-ref $PROJECT_ID CRON_SECRET=${{ secrets.CRON_SECRET }}
          supabase secrets set --project-ref $PROJECT_ID THESPORTSDB_API_KEY=${{ secrets.THESPORTSDB_API_KEY }}
