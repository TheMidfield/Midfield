name: Verify Production Secrets

on: [workflow_dispatch]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Test Secrets Presence & Connectivity
        env:
          SB_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SB_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TSDB_KEY: ${{ secrets.THESPORTSDB_API_KEY }}
        run: |
          echo "🔍 STARTING SECRETS AUDIT..."
          
          # 1. Check if set
          if [ -z "$SB_URL" ]; then echo "❌ NEXT_PUBLIC_SUPABASE_URL is MISSING"; else echo "✅ NEXT_PUBLIC_SUPABASE_URL is set"; fi
          if [ -z "$SB_KEY" ]; then echo "❌ SUPABASE_SERVICE_ROLE_KEY is MISSING"; else echo "✅ SUPABASE_SERVICE_ROLE_KEY is set"; fi
          if [ -z "$TSDB_KEY" ]; then echo "❌ THESPORTSDB_API_KEY is MISSING"; else echo "✅ THESPORTSDB_API_KEY is set"; fi

          # 2. Test Supabase Connection (using Service Key)
          echo "------------- CHECKING SUPABASE -------------"
          RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -H "apikey: $SB_KEY" -H "Authorization: Bearer $SB_KEY" "$SB_URL/rest/v1/fixtures?select=count&head=true")
          if [ "$RESPONSE_CODE" -eq "200" ] || [ "$RESPONSE_CODE" -eq "206" ]; then
            echo "✅ Supabase Connection: SUCCESS (HTTP $RESPONSE_CODE)"
          else
            echo "❌ Supabase Connection: FAILED (HTTP $RESPONSE_CODE)"
            echo "   -> Check URL and Service Role Key"
          fi

          # 3. Test TheSportsDB Connection
          echo "------------- CHECKING THESPORTSDB -------------"
          # Using V1 endpoint which is simpler to curl
          TSDB_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "https://www.thesportsdb.com/api/v1/json/$TSDB_KEY/lookupleague.php?id=4328")
          if [ "$TSDB_RESPONSE" -eq "200" ]; then
            echo "✅ TheSportsDB Connection: SUCCESS"
          else
            echo "❌ TheSportsDB Connection: FAILED (HTTP $TSDB_RESPONSE)"
            echo "   -> Check API Key"
          fi
          
          echo "🏁 AUDIT COMPLETE"
